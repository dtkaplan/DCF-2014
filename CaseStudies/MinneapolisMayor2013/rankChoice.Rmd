---
title: "Rank Choice Voting in Minneapolis"
author: "Daniel Kaplan"
date: "April 24, 2014"
output: html_document
---

* [Original vote file](http://vote.minneapolismn.gov/www/groups/public/@clerk/documents/webcontent/2013-mayor-cvr.xlsx)

* Minneapolis voting site [description of ranked-choice voting] ](http://vote.minneapolismn.gov/rcv/index.htm)

* [MPR Story](http://minnesota.publicradio.org/display/web/2013/11/22/politics/ranked-choice-vote-count-programmers)

* [Election Statistics](http://vote.minneapolismn.gov/www/groups/public/@clerk/documents/webcontent/wcms1p-126724.xlsx) saved in `electionStatistics.csv` in case-study directory.  [Map of turn-out](http://vote.minneapolismn.gov/www/groups/public/@clerk/documents/webcontent/wcms1p-126706.pdf)

* Some [census information](http://www.minneapolismn.gov/census/2010/index.htm) about the city and by [ward](http://www.minneapolismn.gov/www/groups/public/@cped/documents/webcontent/wcms1q-068925.pdf).

* [Wikipedia description](http://en.wikipedia.org/wiki/Minneapolis_mayoral_election,_2013)

```{r include=FALSE}
library(dplyr)
library(lattice)
library(ggplot2)
require(igraph)
```

## Data Cleaning for the `Minneapolis2013.rda` file

```{r}
require(stringr)
fileName <- "/Users/kaplan/KaplanFiles/DCF-2014/CaseStudies/MinneapolisMayor2013/MinneapolisMayor-2013.csv"
Minneapolis2013 <- read.csv(file.name)
Minneapolis2013 <- Minneapolis2013[,-5]
names(Minneapolis2013) <- c("Precinct","First","Second","Third")
# separate precinct into both precinct and ward
precinct <- Minneapolis2013$Precinct
tmp <- gsub("MINNEAPOLIS ",'',precinct)
tmp2 <- stringr::str_match(tmp, "^(W-[0-9]+.*) (P-[0-9]+.*)$")
Minneapolis2013$Precinct <- factor(tmp2[,3])
Minneapolis2013$Ward <- factor(tmp2[,2])
```

* [Maps of Precincts](http://vote.minneapolismn.gov/results/election-maps)
## The Votes

```{r}
votes <- read.csv("MinneapolisMayor-2013.csv",stringsAsFactors=FALSE)
votes <- select(votes,2:4)
names(votes) <- c("First","Second","Third")
votes <- mutate(votes,whoFrom=First,currentVote=First)
```

Maybe give them first the data with the minor candates (after the first four), listed as 'minor'

***cases and variables***

Ask, what are the cases?  What are the variables?


## Simple Tally

Count the votes and present the results in order from largest to smallest.

***tally***, ***barplot***
```{r}
group_by(votes, currentVote) %.% dplyr::tally(sort=TRUE) -> 
  voteCount
```

```{r}
ggplot(data=voteCount,aes(x=reorder(currentVote,n),y=n ))+geom_bar(stat='identity',position=position_stack(width=.9)) + theme(axis.text.x=element_text(angle=60,hjust=1)) 
```

Just creating a simpler dataset for the students to start with.
```{r}
keepers <- filter(voteCount,n>500)$currentVote
# replace the minors
simpleVotes <- mutate(votes,
                       First=ifelse(First %in% keepers,First,'Minor'),
                       Second=ifelse(Second %in% keepers,Second,'Minor'),
                       Third=ifelse(Third %in% keepers,Third,'Minor'),
                       currentVote=First,whichGroup=First)

```


### Who is the second-place vote for each first-place

```{r}
group_by(simpleVotes,First,Second) %.% dplyr::tally(sort=TRUE) -> pairs
ggplot(data=pairs,aes(x=reorder(First,n),y=n ,fill=Second))+geom_bar(stat='identity',position=position_fill(width=.9)) + theme(axis.text.x=element_text(angle=60,hjust=1)) 
```

### A Network 

***connections***

```{r}
filter(pairs, n>200) -> foo 
gg <- graph.data.frame(select(foo,First,Second),directed=FALSE)
E(gg)$color <- 'red'
E(gg)$width <- 10*sqrt(foo$n/5000)
plot(gg)
gg$layout <- layout.circle
plot(gg)
```

[A blog tutorial on igraph](http://www.r-bloggers.com/network-visualization-in-r-with-the-igraph-package/) shows how to set colors, etc.

### The vote-counting process

***head***, ***tail***, ***arrange***, ***sort***, ***order***



***conditional choice***

```{r}
removeOne <- function(V,who=NULL,round=0){
  if(is.null(who)) {
    # Find the person with the lowest vote total
    group_by(V,currentVote) %.% dplyr::tally(sort=TRUE) %.% 
      filter(currentVote!='none') -> tmp
    who <- tail(tmp,1)$currentVote
  }
  message(paste('Candidate dropped:', who))
  return( 
    mutate(V,
           Third=ifelse(Third==who,'none',Third),
           Second=ifelse(Second==who,Third,Second),
           First=ifelse(First==who,Second,First),
           whoFrom=ifelse(currentVote==First,whoFrom,currentVote),
           currentVote=First
           )
    )
  }
```

# Work through the process
```{r}
makePlot <- function(Votes) {
  group_by(Votes,currentVote,whoFrom) %.% dplyr::tally(sort=TRUE) %.%
filter(currentVote != 'none') -> Counts
  ggplot(data=Counts,aes(x=reorder(currentVote,n),y=n ,fill=whoFrom))+geom_bar(stat='identity',position=position_stack(width=.9)) + theme(axis.text.x=element_text(angle=60,hjust=1)) + xlab("") + ylab('Number of Votes')
  }
```

## The sequence of plots

***stacked barplot***

```{r}
step <- simpleVotes
makePlot(step)
for (k in 1:10) {
  step <- removeOne(step)
  print(makePlot(step))
}
```



# Process the simpleVotes

