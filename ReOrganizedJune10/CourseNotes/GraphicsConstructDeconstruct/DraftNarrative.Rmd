---
output:
  html_document:
    css: ~/KaplanFiles/DCF-2014/ReOrganizedJune10/CSS/DCF-style.css
    fig_caption: yes
    toc: yes
---

```{r child="/Users/kaplan/KaplanFiles/DCF-2014/ReOrganizedJune10/CSS/DCF-common.Rmd"}
```

```{r include=FALSE}
library(xkcd)
```

Data graphics provide one of the most accessible, compelling, and expressive modes to investigate and depict patterns in data.  Statistical models are another important mode, but it typically takes considerable training to understand statistical models.

The point of these notes is to

* show examples of standard kinds of data graphics, what they are used for, and how to read them;
* provide simple, high-level interactive computer commands for making common sorts of graphics; 
* introduce a unifying framework --- a grammar --- for describing and specifying graphics, so that you can create custom graphics types that support displaying data in a purposeful way.

## Common Kinds of Graphs

There are many, many different genres of data graphics, and many different variations on each genre.  Here are some of the most commonly encountered kinds.

* Scatterplots showing relationships between two or more variables.
* Displays of distribution, such as histograms.
* Bar charts, comparing values of a single variable across groups.
* Maps, showing how a variable relates to geography. 
* Network diagrams, showing how entities are connected to one another.

You are likely to be familiar with some or all of these genres.

### Scatter plots

The main purpose of a scatter plot is to show the relationship between two variables across several or many cases.  Most often, there is a Cartesian coordinate system in which the x-axis represents one variable and the y-axis the value of a second variable.



Example: Consider the NHANES data giving medical and morphometric measurements of individual people.  Here is a scatter plot showing the relationship between two variables: height and age.

```{r echo=FALSE}
data(NHANESDCF)
set.seed(208)
NHANES %>% sample_n( size=1000 ) %>%
  ggplot(aes(x=age, y=height)) + geom_point() + 
  xlab("Age (years)") + ylab("Height (m)") -> pheight
pheight
```

Each dot is one case.  The position of that dot signifies the value of the two variables for that case. 



### Displays of Distribution

A histogram shows how many cases fall into given ranges of the variable.  For instance, here's a histogram of heights from NHANES:

```{r}
ggplot(NHANES, aes(x=height)) + 
    geom_histogram(aes(y = ..count..), 
                   binwidth=0.1, color="black", fill=NA) + 
    xlab("Height (m)") + ylab("Count")
```

The most common height is about 1.65 m --- that's the location of the tallest bar.  Only a handful are taller than 2.0 m.

A simple alternative to a histogram is a *frequency polygon*.  It's like a histogram but without the bars.  

To illustrate, here's a frequency polygon of NHANES height. To show the relationship of the polygon with the histogram, the histogram has been drawn in the background. 

```{r}
ggplot(NHANES, aes(x=height)) + 
    geom_freqpoly( aes(y= ..count..),binwidth=0.1,
                  color="black",fill=NA) + 
    geom_histogram(aes(y = ..count..), 
                   binwidth=0.1, color=rgb(0,0,1,.2), fill=NA) + 
    xlab("Height (m)") + ylab("Count")
```

Frequency polygons make it straightforward to include other variables, like sex:

```{r}
ggplot(NHANES, aes(x=height)) + 
    geom_freqpoly(aes(y = ..count.., color=sex), 
                   binwidth=0.1, fill=NA) + 
    xlab("Height (m)") + ylab("Count")
```

It's also common to display the distribution of cases across two variables.  

```{r echo=FALSE}
ggplot(NHANES, aes(x=age, y=height)) + geom_hex() + 
  xlab("Age (years)") + ylab("Height (m)")
```

This is much like a scatter plot, but without the distraction of the individual dots.


### Bar Charts

The familiar bar chart is effective when the objective is to compare a few different quantities.

Example: From the NHANES data, how likely is a person to have died during the follow-up period, based on their age group?

```{r echo=FALSE}
data(NHANESDCF)
NHANES %>% 
#  mutate( ageGroup=ntile(age, 7) ) %>% 
  mutate( ageGroup=cut( age, c(20,30,40,50,60,70,80,90,100) ),
          death2=ifelse(is.na(death), 'alive', death)) %>% 
  group_by( smoker, sex, ageGroup, death ) %>%
  summarise( count=n() ) -> NHANEScts
## Not using death2, which counts NA in followup as alive.
## First plot
NHANEScts %>% 
  group_by( ageGroup, death ) %>%
  summarise( count=sum(count) ) -> ByAge
ByAge %>% group_by( ageGroup ) %>% 
  mutate( total=sum(count)) %>%
  filter( death=="alive" ) %>%
  mutate( fracAlive=count/total ) -> FracAlive
```

```{r echo=FALSE,warning=FALSE}
FracAlive %>% na.omit %>% 
  ggplot(aes(x=ageGroup,y=fracAlive)) + 
  geom_bar(stat='identity',position=position_stack(width=.9),
           alpha=.5) + ylab( "Fraction Alive at End of Follow-Up" ) +
  xlab("Age") + 
  theme_xkcd()
```

It's easy to compare bars to their neighbors and to discern the overall trend: survival goes down as age goes up. 

There's plenty of space taken up the bars to include information about other variables.

For instance, here's a comparison between smokers and non-smokers:

```{r echo=FALSE,warning=FALSE}
NHANEScts %>% 
  group_by( smoker, ageGroup, death ) %>%
  summarise( count=sum(count) ) -> ByAgeSmoke
ByAgeSmoke %>% group_by( smoker, ageGroup ) %>% 
  mutate( total=sum(count)) %>%
  filter( death=="alive" ) %>%
  mutate( fracAlive=count/total ) -> FracAliveSmoke
FracAliveSmoke %>% na.omit() %>% mutate( `Smoking Status`=smoker) %>% 
ggplot(aes(x=ageGroup, y=fracAlive ,fill=`Smoking Status`))+
geom_bar(stat='identity',position="dodge") + 
  ylab("Fraction Alive at end of Follow-Up") +
  xlab("Age") + 
  theme_xkcd()
```

At each age, smokers were less likely than non-smokers to have survived to the end of the study's follow-up period.


### Maps

Using a map to plot data helps both to identify particular cases and to show spatial patterns and discrepancy.  

```{r echo=FALSE,message=FALSE}
Growth <- CIAdata(2002)
Growth$growth <- pmin(Growth$growth,5)
p <- makeWorldMap( Growth, 'country')
p + geom_polygon(col="gray",width=.5,aes(fill=growth)) +
  xlab("Longitude") + ylab("Latitude") + ggtitle("Population Growth (% per year)") + 
  scale_fill_continuous( low = "lightblue", high = "red", space = "Lab",
  na.value = "grey50", guide = "colourbar") 
```

From this map of population growth (in % per year), you can see the handful of countries with negative growth (that is, population decline) such as Russia and Poland.  The countries in Africa, with the exception of South Africa and Namibia, have fast population growth.  (A rate of 5% per year means that the population will double every 14 years.)

### Networks

A *network* is a set of connections, called *edges*, between elements, called *vertices*. A vertex corresponds to a case. The network describes which vertices are connected to other vertices. 

The `NCI60` data set (in the DCFdevel package) is about the genetics of cancer.  The data set looks at more than 40,000 probes for the expression of genes, in each of 60 cancer cell lines. In the network here, a vertex is a given cell line --- a sample of cells from one person with a particularly kind of cancer.

To measure the connections between cell lines, the correlation coefficient for probe expression in every pair of cell lines was calculated.  Each pair's correlation coefficient indicates the strength of connection between the two cell lines in that pair. Here, the 200 largest correlations are shown.




```{r echo=FALSE}
# An example
CellEdges <- read.csv("nciNetwork.csv")
SmallEdges <- head(CellEdges,200)
VV <- edgesToVertices( SmallEdges, 
                       from=cellLine, to=otherCellLine )
VV$width = 1:nrow(VV)
VV$color <- runif(nrow(VV))
EE <- edgesForPlotting( VV, ID=ID, x=x, y=y,
                        SmallEdges, 
                        from=cellLine, to=otherCellLine) 
VV$type <- substr(VV$ID,0,2)                       
ggplot(EE, aes(x=x,y=y)) + 
  geom_segment(size=2,
               aes(
                 xend=xend,yend=yend,
                 alpha=abs(correlation)),
               ) + 
  geom_point(data=VV,aes(x=x,y=y,color=type,size=size),
             size=12,fill="lightgray",alpha=.4) +
  geom_text( data=VV, aes(x=x,y=y, label=type)) +
  theme(legend.position="none")
```

Every vertex, that is, every cell line, is depicted as a dot.  The dot's color and label gives the type of cancer involved.  These are Ovarian, Colon, Central Nervous System, Melanoma, Renal, Breast, and Lung cancers. 

The network shows that the melanoma cell lines (ME) are closely related to each other and not so much to other cell lines.  The same is true for colon cancer cell lines (CO) and for central nervous system (CN) cell lines.

## Making Data Graphics: Introduction

Steps:

1. Choose a modality: scatter(), density(), barplot(), network()
2. Choose the variable that corresponds to each aspect of the plot.
3. Cut and paste the command into your report.

These functions just construct graphics.  The data already need to be in a form where there is a variable for each aspect being used, e.g. an x- and y-variable for a scatter plot.




### FOR GRAPHICAL DECISIONS

Redo the NHANES mortality as a logistic regression.



Show fraction alive as a function of sex and smoking status.

Show proportion in each age of the height ntiles.  Stack them. 


### EXERCISE

Show these graphs and ask them to explain what they show.

### EXERCISE


FOR GRAMMAR SECTION: Density plots draw on cases collectively.

#### EXERCISE

Explain what the frequency polygon and the density smoother say about the heights of males and females. 

#### For design choices

Why not a histogram: Displaying two variables.

```{r}
ggplot(NHANES, aes(x=height)) + 
    geom_histogram(aes(y = ..count..,color=sex,fill=sex), 
                   binwidth=0.1) + 
    xlab("Height (m)") + ylab("Count")
```

In talking about position/dodging, use this example of a misleading plot.

```{r}
ggplot(NHANES, aes(x=height)) + 
    geom_freqpoly(aes(y = ..density.., color=sex), 
                   binwidth=0.1, fill=NA, position="stack") + 
    xlab("Height (m)") + ylab("Count")
```



Stacking bars or polygons or densities: make sure to fill them in so that the reader can figure out which group is which.  If you want them to overlap, fill them with transluscent color.




##### Density Plots

```{r}
ggplot(NHANES, aes(x=height)) + 
    geom_density(aes(y = ..density.., color=sex), 
                   binwidth=0.1, fill=NA) + 
    xlab("Height (m)") + ylab("Count")
```

#### Design Decisions

Dealing with very large datasets:

* Transparency in scatter plots.
* Use densities rather than cases.

#### MOVE TO "Design Decisions"

In principle, the variables could be assigned to the other axes, but typically there is some purpose behind the use of a scatter plot, for instance to show how height varies with age.  It's conventional to put the *response variable* on the y-axis and the *explanatory variable* on the x-axis.  Other terms for "explanatory variable" include "independent variable" or "causal variable."  The "response variable" is also known as the "dependent variable", "result," or "effect." 


Often, the size, shape, or color of the "dots" is used to show the value of another variable.  For instance:

```{r echo=FALSE}
pheight + geom_point(aes(color=sex))
```

### For an exercise:

What does this graph tell you about pregnancy?

ggplot(data=NHANES, aes(x=pregnant, y=age)) + geom_violin()  + theme(legend.position="none") + labs(title="") 

ggplot(data=NHANES, aes(x=pregnant, y=age)) + geom_violin()  + aes(colour=sex) + facet_wrap(~smoker, ncol=4) + theme(legend.position="none") + labs(title="") + coord_flip() 

### Exercise:

Make a graph to indicate whether smokers are systematically lower in weight than non-smokers.

ggplot(data=NHANES, aes(x=smoker, y=BMI)) + geom_violin()  + theme(legend.position="none") + labs(title="")
