---
title: "20 Minutes with ggplot2"
author: "Daniel Kaplan"
date: "TCRUG --- November 20, 2014"
output: ioslides_presentation
---

```{r include=FALSE}
library( mosaicData )
library( NHANES )
library( mosaicData )
library( ggplot2 )
library( ggthemes )
library( dplyr )
library( knitr )
library( DCF )
opts_chunk$set( warning=FALSE, message=FALSE, 
                tidy=FALSE,
                out.width="40%", fig.height=6,
                results="hold", fig.align="center")
set.seed(101)
options( width=100 )
NHANES <- sample_n( NHANES, 5000 )
```

## Why Use ggplot?

The `ggplot2` package provides a system for

* data graphics with a ...
* professional look, that can ...
* easily be layered and extended.

Decisions about axis ranges and "keys" are  

+ made sensibly out of the box and 
+ can be overridden manually.

## Lattice Graphics? Base Graphics?

For graphing data, your choice is between lattice and ggplot

`lattice` provides many of the same features as ggplot.  

* lattice has an easier basic syntax
* ggplot has a more consistent notation

"*Base graphics are good for drawing pictures; ggplot2 graphics are good for understanding the data*." --- Wickham, 2012

## Resources

* *R Graphics Cookbook: Practical Recipes for Visualizing Data*, Winston Chang (2012) O'Reilly 
* *Introduction to ggplot2*, Dawn Koffman (2014) [slides](http://opr.princeton.edu/workshops/201401/ggplot2Jan2014DawnKoffman.pdf)
* Many other tutorials, particularly oriented to the beginner.
* Galleries, e.g. [one](http://rstudio-pubs-static.s3.amazonaws.com/5051_39c30acbb432498fa1a290f166c6b403.html)
* `GGally` package with extensions to `ggplot2`.
* `ggthemes` package for systematic styling of graphics.

Link to source file for this presentation ...
```{r echo=FALSE,results='asis'}
includeSourceDocuments("ggplot-TCRUG.Rmd")
```

## My Goal

Describe the conceptual structure of ggplot commands and cover the basic vocabularly.

I want you to be able to **read** ggplot commands.

If you can read, you can decide what to copy.  Most programming starts with copying something that already works.  


## The Grammar's "Parts of Speech"

Once you know these, you can read, which means you can extend the many examples available on the Internet.

* **Data**:  data.frames only^[with a few exceptions], variables within data.frames
* **Frame**: the spatial area in which the plot is made
* **Aesthetic**: a perceivable attribute, e.g. position, color, size, shape, ...
* **Glyph** or "Mark" or `geom`: Graphical attributes for each data case, "aesthetics", to be shown in the frame.
* **Stat**: Display of aggregate properties of data.
* **Scale**: a translation from a specific graphical attribute (e.g. color) to the levels of a specific variable.
* **Guide**: a text/graphical depiction of a scale

## Others parts not covered here:

* **Coordinate system**: e.g. map projections, radial, logarithmic ...
* **Facet**: split up into sub-plots
* **Annotation**
* Fine tuning to set scales (esp. for color)

## Grammar Drill

<img src="http://www.sciencesurvivalblog.com/wp-content/uploads/2009/11/temp_zonder_errors.jpg" width="500px">

Variables? Frame? Layers? Glyphs and their aesthetics, Guides?

## Grammar Drill

<img src="http://www.sciencesurvivalblog.com/wp-content/uploads/2009/11/temp_met_errors.jpg" width="500px">

Variables? Frame? Layers? Glyphs and their aesthetics, Guides?

## Grammar Drill

<img src="http://ccnmtl.columbia.edu/projects/mmt/frontiers/web/images/figures/03/fig03.gif" width="500px">

Variables? Frame? Layers? Glyphs and their aesthetics, Guides?

## Grammar Drill

<img src="http://www.reportingclimatescience.com/typo3temp/pics/9821618bca.png" width="500px">

Variables? Frame? Layers? Glyphs and their aesthetics, Guides?

## Making a Frame

The frame is the meaning of space in the graphic.

A graphic requires a frame and one or more layers.

`ggplot()` creates a new frame for you to add layers to.

### Data for Examples

```{r echo=FALSE}
monthNames <- factor( 1:12, levels=1:12, 
                      labels=c("Jan","Feb","Mar","Apr","May","June", 
                               "July","Aug","Sept", "Oct","Nov","Dec"))
seasons <- c(Jan="Winter", Feb="Winter", Dec="Winter", Mar="Winter",
             Apr="Spring", May="Spring", 
             June="Summer", July="Summer", Aug="Summer",
             Sept="Fall", Oct="Fall", Nov="Fall"
             )
theSeasons <- c("Winter","Spring","Summer", "Fall")
```

```{r}
data( Utilities, package="mosaicData" ) 
# see slide source file for details
# of adding categorical "month" and "season"
```

```{r echo=FALSE}
Utilities <- Utilities %>%
  mutate( month=monthNames[month], 
          season=factor(seasons[as.character(month)],levels=theSeasons) )
```

```{r}
names( Utilities )
```

## Some Frames

x and y can be either categorical or quantitative.

```{r}
ex1 <- ggplot( data=Utilities, aes( x=month, y=ccf ))
ex2 <- ggplot( data=Utilities, aes( x=temp, y=gasbill ))
```

Until there is a layer, there's nothing to display!
```{r error=TRUE}
ex2
```

## Add a layer ...

If you've set up the frame with reference data and variables for space, just say what kind of glyph you want ...

```{r}
ex2 + geom_point( )
```

## *Set* properties of a layer

Within a layer, you can specify values for graphical characteristics.  When these are the same for all cases, this is called "setting."

```{r}
ex2 + geom_point( alpha=.3, color="blue" )
```

Note: Scales for $x$- and $y$-axes indicated by *guides*.

## *Map* properties of a layer

When the graphical characteristics of each glyph are to be properties based on individual cases in the data, you **map** a variable onto the property. This is signaled by stating the equivalence within `aes()`.

```{r}
ex3 <- ex2 + geom_point( aes( color=month, size=kwh/billingDays ) )
ex3
```

Note: Scales and guides for `ccf` and `month` created and shown

## There are many geoms available

[Graphical list](http://docs.ggplot2.org/current/)

<div style="font-size:10px"><code>
```{r echo=FALSE, results='asis',prompt=FALSE,comment=""}
help.search("^geom_",package="ggplot2")$matches[,1:2]
# ls(getNamespace("ggplot2"), pattern="^geom_")
```
</code></div>

## Another layer

```{r}
ex4 <- ex3 + geom_point( aes(y=elecbill) ) + 
  ylab("Amount of Bill ($)")
ex4
```

## Stats

Geoms show individual cases in the data.

Stats show aggregate properties of the cases.

```{r}
ggplot( Utilities, aes(x=season, y=temp) ) +
  stat_boxplot( aes( fill=season ) )
```

## There are many stats ...

[Graphical list](http://docs.ggplot2.org/current/)

<div style="font-size:10px"><code>
```{r echo=FALSE, results='asis',prompt=FALSE,comment=""}
help.search("^stat_",package="ggplot2")$matches[,1:2]
```
</code></div>

## Commonly used stats

* density plots (1- and 2-d)
* box-and-whisker plots
* linear and logistic regression
* smoothers

## Layers can be both geoms and stats

```{r}
ggplot( Utilities, aes(x=month, y=temp) ) +
  stat_boxplot( alpha=.3, aes( fill=season ) ) +
  geom_point( aes( color=season ) )
```

## Use a different aesthetic for each variable

All geoms and stats must work with the same frame.

```{r}
ex5 <- ggplot( Utilities, aes(x=month, y=temp) ) +
  stat_boxplot( alpha=.3, aes( fill=season ) ) +
  geom_point( aes(size=elecbill, color=season ) ) +
  stat_smooth( aes(group=1) ) 
ex5
```


## Theme


```{r}
ex5 + theme_economist()
```

## Theme

```{r}
ex5 + theme_excel()
```

## Theme

```{r}
ex5 + theme_wsj()
```

## Theme

```{r}
ex5 + theme_tufte()
```

<!--

## Quiz

* What is the frame?
* What are the glyphs?
* How many layers?
* What is a guide?

Some weather graphics [here](https://www.google.com/search?q=new+york+times+temperature+high+low+weekly+by+city&espv=2&biw=1280&bih=706&source=lnms&tbm=isch&sa=X&ei=KCBqVPuxGIL4yQSi44HICA&ved=0CAgQ_AUoAw#tbm=isch&q=temperature+graphic+error+bars&imgdii=_)

-->

## Moving Forward

Remember ... Start with a working example and tweak it!

### Common Blunders ...    

* Leaving out the `+`
* Failing to wrap a mapping in `aes()`     
    e.g. ~~`geom_point( color=sex )`~~
* Wrapping a setting in `aes()`     
    e.g. ~~`geom_point( aes(color="blue") )`~~
    
## Conceptual/Style mistakes ...  

* Using mis-matched variables for the position in a layer
    e.g. when frame is `temp` vs `month`, each geom or stat must have y as a `temp`-like value, and x as a `month`-like value.
    
    * `mean( temp )` as y -- Yes
    * `sd( temp )` or SE or CI as y -- Yes
    * `var( temp )` as y -- Not reasonable
    * `elecbill` as y -- Not reasonable 
    * `season` as x -- No
* Using continuous color scales for non-contiguous glyphs.